---
title: Redis 分布式锁之 RedLock
date: 2021-07-22 21:01:01.716
updated: 2021-08-10 17:10:24.175
url: redis-distributed-lock
categories: 
- Redis
tags: 
- Redis
- 分布式
- 锁
- 分布式锁
---

#### 使用场景
分布式场景下保证同一时刻内只能有一个客户端对资源进行操作。
#### 保证分布式锁有效性及安全性的要求
- 互斥性：任何时刻只能有一个客户端持有锁。
- 可重入：总是可以获取锁，即使锁定资源的客户端崩溃，避免死锁。
- 高可用：只要大多数 Redis 节点已启动，客户端就可以获取锁和释放锁。

#### 获取锁
1. 以毫秒为单位获取当前时间戳。
2. 以相同的键名和值尝试获取所有实例的锁。
3. 客户端以当前时间减去开始获取锁的时间得到锁使用的时间。当大多数Redis节点（N/2+1）获取到锁并且锁使用时间小于锁的失效时间，锁才算获取成功。
4. 如果获取到锁，锁的真正有效时间为步骤三计算结果。
5. 如果获取锁失败，客户端应该在所有实例上进行解锁。

#### 释放锁
向所有的 Redis 实例发送释放锁的命令，不用关心之前有没有成功获取到锁。
